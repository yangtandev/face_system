# 開發與修正交接文件 (2025-12-01)

本文檔旨在記錄近期對臉部辨識系統進行的一系列重大修改與錯誤修復，方便後續開發者能快速進入狀況。

## 1. 核心功能變更：基於臉部特徵點的「無額頭」裁切

*   **問題**：原系統對使用者是否佩戴安全帽或帽子非常敏感，影響辨識率。
*   **解決方案**：
    1.  在 `function.py` 中新增了一個核心函式 `crop_face_without_forehead`。此函式利用 MTCNN 偵測到的臉部特徵點（特別是眼睛），動態計算出一個不包含額頭和頭髮的臉部區域，並以此進行裁切。
    2.  修改 `face_main.py` 中的 `_generate_new_descriptors` 函式，在建立人員的臉部特徵檔 (`.npy`) 時，強制使用此新裁切邏輯。
    3.  修改 `init/model.py` 中的 `Comparison.face_comparison` 函式，在進行即時影像比對時，也使用完全相同的裁切邏輯，確保了註冊和辨識兩端的一致性。
    4.  為了確保所有舊資料都更新，修改 `face_main.py` 中的 `update_data_and_model` 函式，使其在每次更新時都會刪除所有舊的特徵檔，並用新邏輯重新產生。

## 2. 簽到/簽離邏輯的穩定性修復

*   **問題 1：辨識成功但無後續動作 (Race Condition)**
    *   **原因**：`init/model.py` 中的 `Comparison` 執行緒在設定「辨識成功」訊號後，幾乎立即在下一個迴圈將其重設，導致主程式的 `CameraSystem` 執行緒極難捕捉到此訊號。
    *   **修復**：移除了 `Comparison.face_comparison` 中多餘的訊號重設程式碼，確保訊號能被穩定處理。

*   **問題 2：刷出功能看似卡住/阻塞**
    *   **原因**：後端 API 在處理簽離時回傳 `202 Accepted` 狀態碼，但程式只認 `201 Created` 為成功，導致不斷重試。
    *   **修復**：修改 `function.py` 中的 `async_api_call` 函式，將 `201` 和 `202` 都視為成功狀態，解決了刷出失敗的問題。

*   **問題 3：狀態不一致**
    *   **原因**：舊邏輯在發起 API 呼叫前就更新了本地狀態，若 API 呼叫失敗，會導致本地與遠端資料不一致。
    *   **修復**：重構了 `async_api_call`，將狀態更新的動作移至背景執行緒中，確保只有在 API 呼叫成功後，才更新本地狀態。

*   **問題 4：刷出後立即又被刷入**
    *   **原因**：刷出成功後，清除該人員狀態的計時器只有 5 秒，過短。
    *   **修復**：在 `function.py` 中，將 `clear_leave_employee` 的觸發計時器從 5 秒延長至 **60 秒**。

## 3. 音訊系統 (語音播報) 全面修復

*   **問題 1：程式因音訊問題啟動緩慢或崩潰 (ALSA Errors)**
    *   **原因**：`pygame.mixer.init()` 在主程式啟動時執行，若系統找不到音效卡，此動作會長時間阻塞，拖慢啟動速度，甚至導致程式崩潰。
    *   **修復**：修改 `init/say.py`，將 `mixer.init()` 的動作完全移入背景的語音播放執行緒中，並只在第一次嘗試播放時執行一次。這徹底解決了音訊問題對主程式啟動的影響。

*   **問題 2：語音重複播報或後續無聲**
    *   **原因**：短時間內重複的辨識會觸發多次語音請求，`pygame.mixer` 可能因此錯亂或卡住 (`get_busy()` 狀態不更新)。
    *   **修復**：
        1.  在 `function.py` 中為語音播報增加了**每個人 5 秒的冷卻機制**，避免重複請求。
        2.  在 `init/say.py` 中，移除了不可靠的 `while mixer.music.get_busy()` 等待迴圈，改為在播放新語音前，先用 `mixer.music.stop()` **強制停止當前所有聲音**，確保新請求的即時性。

## 4. 日誌與組態功能的易用性改進

*   **問題 1：啟動延遲原因不明**
    *   **解決方案**：在 `face_main.py` 的啟動流程中，為載入各個 AI 模型 (`MTCNN`, `Resnet`, `YOLO`) 和人臉特徵資料庫等耗時操作，都加入了詳細的 log，讓使用者清楚了解程式正在進行的步驟。

*   **問題 2：日誌資訊不完整**
    *   **解決方案**：修改 `function.py` 中的 `log_metrics` 函式，將**信賴度 (confidence)** 的值直接整合進「進入/離開」的主要日誌中，格式如：`攝影機編號:0, 人員:Yang 進入, 信賴度: 74.47%`。

*   **問題 3：功能無法開關**
    *   **解決方案**：在 `function.py` 中為 Excel API 的呼叫增加了 `excel_api_enabled` 的開關，使用者現在可以透過 `config.json` 靈活控制此功能。
